<html>
  <head>
    <title>Electron/ffmpeg realtime transcoding Experiment</title>
    <style>
      body {
        background-color: black;
        color: rgb(245, 245, 245);
        overflow:hidden;
      }
      #clientPane {
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
      }
      .fvideo {
        position: absolute;
        bottom: 0;
        top: 0;
        width: 100%;
        display: block;
      }
      #input {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        display: block;
        ime-mode: disabled;
        z-index: 3;
      }
      #time {
        position: absolute;
        top: 10;
        right: 10;
        width: 30%;
        text-align: right;
        display: block;
        font-family: monospace;
        z-index: 3;
      }
      #stats {
        position: absolute;
        top: 10;
        left: 10;
        width: 80%;
        display: block;
        font-family: monospace;
        z-index: 3;
      }
    </style>
  </head>
  <body>
    <div id="clientPane">
      <video class='fvideo' id='video' autoplay style='z-index: 1'></video>
      <canvas class='fvideo' id='pause' style='z-index: 0'></canvas>
      <input id='input' type='text'>
      <span id='time'>00:00:00.00/00:00:00.00</span>
      <div id='stats'>Drop movies to the window.</div>
    </div>
    <script>
      let electron = require('electron');
      let clientPane = document.getElementById('clientPane');
      window.onresize = () => {
        clientPane.style.width = window.innerWidth +'px';
        clientPane.style.height = window.innerHeight +'px';
      };
      clientPane.ondragover = e => e.preventDefault();
      clientPane.ondrop = e => {
        e.preventDefault();
        let file = e.dataTransfer.files[0].path;
        console.log(file);
        electron.ipcRenderer.send('movie', {
          filename: file,
          width: 1280, //1920 / 2,
          height: 720, //1080 / 2
          seek: 0
        });
      };
      let player = document.getElementById('video');
      let banner = document.getElementById('pause');
      player.addEventListener('playing', () => {
        banner.style['z-index'] = 0;
        banner.width = player.videoWidth;
        banner.height = player.videoHeight;
        banner.style.display = 'block';
        player.style.display = 'block';
      });
      electron.ipcRenderer.on('movie-url', (event, url) => {
        banner.getContext('2d').drawImage(player, 0, 0);
        banner.style['z-index'] = 2;
        player.src = url;
      });
      electron.ipcRenderer.on('movie-stats', (event, stats) => {
        document.getElementById('stats').innerHTML = Object.keys(stats).map(k => k + ': ' + stats[k] + '<br>').reduce((p, c) => p + c);
      });
      electron.ipcRenderer.on('movie-time', (event, time) => {
        document.getElementById('time').innerText = time.time + '/' + time.duration;
      });
      const input = document.getElementById('input');
      input.focus();
      input.addEventListener('keyup', e => {
        event.preventDefault();
        if (e.keyCode === 13) {
          electron.ipcRenderer.send('seek', input.value);
          input.value = '';
        }
      });
    </script>
  </body>
</html>
